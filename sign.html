<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LegalLens â€” Sign Document</title>

  <!-- PDF.js for in-browser PDF rendering -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --indigo: #6366f1;
      --indigo-dark: #4f46e5;
      --purple: #8b5cf6;
      --green: #22c55e;
      --red: #ef4444;
      --gray-50: #f8fafc;
      --gray-100: #f1f5f9;
      --gray-200: #e2e8f0;
      --gray-500: #64748b;
      --gray-700: #334155;
      --gray-900: #0f172a;
    }

    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: var(--gray-100);
      color: var(--gray-900);
      min-height: 100vh;
    }

    /* â”€â”€ Top bar â”€â”€ */
    .topbar {
      background: white;
      border-bottom: 1px solid var(--gray-200);
      padding: 14px 32px;
      display: flex;
      align-items: center;
      gap: 12px;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 1px 4px rgba(0,0,0,0.06);
    }
    .topbar-logo {
      width: 36px; height: 36px;
      background: linear-gradient(135deg, var(--indigo), var(--purple));
      border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
      font-size: 18px;
    }
    .topbar-title { font-weight: 700; font-size: 18px; color: var(--gray-900); }
    .topbar-subtitle { font-size: 13px; color: var(--gray-500); margin-left: auto; }

    /* â”€â”€ Layout â”€â”€ */
    .layout {
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 0;
      height: calc(100vh - 65px);
    }

    /* â”€â”€ Left: PDF Viewer â”€â”€ */
    .pdf-panel {
      background: #525659;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 24px 16px;
      gap: 16px;
    }
    .pdf-loading {
      color: white;
      font-size: 15px;
      margin-top: 60px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
    }
    .spinner {
      width: 40px; height: 40px;
      border: 3px solid rgba(255,255,255,0.2);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .pdf-page-wrapper {
      background: white;
      box-shadow: 0 4px 20px rgba(0,0,0,0.4);
      border-radius: 4px;
      overflow: hidden;
    }
    .pdf-page-wrapper canvas { display: block; }

    .pdf-toolbar {
      background: rgba(0,0,0,0.5);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 13px;
      position: sticky;
      bottom: 16px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .pdf-toolbar button {
      background: rgba(255,255,255,0.15);
      border: none;
      color: white;
      padding: 4px 12px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 13px;
    }
    .pdf-toolbar button:hover { background: rgba(255,255,255,0.25); }
    .pdf-toolbar button:disabled { opacity: 0.4; cursor: default; }

    /* â”€â”€ Right: Sign Panel â”€â”€ */
    .sign-panel {
      background: white;
      border-left: 1px solid var(--gray-200);
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }

    /* Screens inside sign panel */
    .screen { display: none; flex-direction: column; height: 100%; }
    .screen.active { display: flex; }

    /* Loading screen */
    #screen-loading {
      align-items: center;
      justify-content: center;
      gap: 16px;
      color: var(--gray-500);
      font-size: 15px;
    }
    #screen-loading .spinner {
      border-color: rgba(99,102,241,0.2);
      border-top-color: var(--indigo);
    }

    /* Error screen */
    #screen-error {
      align-items: center;
      justify-content: center;
      padding: 40px;
      text-align: center;
      gap: 12px;
    }
    .error-icon { font-size: 48px; }
    .error-title { font-size: 20px; font-weight: 700; color: var(--red); }
    .error-msg { color: var(--gray-500); font-size: 14px; line-height: 1.6; }

    /* Sign screen */
    #screen-sign { padding: 28px; gap: 20px; }

    .section-title {
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      color: var(--gray-500);
      margin-bottom: 8px;
    }

    .contract-card {
      background: var(--gray-50);
      border: 1px solid var(--gray-200);
      border-radius: 12px;
      padding: 16px;
    }
    .contract-name { font-size: 17px; font-weight: 700; color: var(--gray-900); margin-bottom: 8px; }
    .meta-row { display: flex; gap: 6px; align-items: center; font-size: 13px; color: var(--gray-500); margin-bottom: 4px; }

    .email-field {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .email-field label { font-size: 13px; font-weight: 600; color: var(--gray-700); }
    .email-field input {
      border: 1.5px solid var(--gray-200);
      border-radius: 8px;
      padding: 10px 14px;
      font-size: 14px;
      color: var(--gray-900);
      outline: none;
      transition: border-color 0.2s;
    }
    .email-field input:focus { border-color: var(--indigo); }
    .email-field input.error { border-color: var(--red); }

    .sig-area {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .sig-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .sig-canvas-wrapper {
      border: 2px dashed var(--gray-200);
      border-radius: 12px;
      background: var(--gray-50);
      overflow: hidden;
      position: relative;
      transition: border-color 0.2s;
    }
    .sig-canvas-wrapper:hover { border-color: var(--indigo); }
    .sig-canvas-wrapper canvas {
      display: block;
      cursor: crosshair;
      touch-action: none;
    }
    .sig-placeholder {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: var(--gray-500);
      font-size: 13px;
      pointer-events: none;
      gap: 6px;
      transition: opacity 0.2s;
    }
    .sig-placeholder-icon { font-size: 28px; opacity: 0.4; }

    .btn-clear {
      background: none;
      border: 1px solid var(--gray-200);
      color: var(--gray-500);
      padding: 5px 12px;
      border-radius: 8px;
      font-size: 12px;
      cursor: pointer;
    }
    .btn-clear:hover { background: var(--gray-100); }

    .consent-box {
      background: #f0fdf4;
      border: 1px solid #bbf7d0;
      border-radius: 10px;
      padding: 14px;
      display: flex;
      gap: 10px;
      align-items: flex-start;
    }
    .consent-box input[type="checkbox"] { margin-top: 2px; accent-color: var(--green); }
    .consent-box label { font-size: 13px; color: #166534; line-height: 1.5; }

    .btn-submit {
      background: linear-gradient(135deg, var(--indigo), var(--purple));
      color: white;
      border: none;
      border-radius: 12px;
      padding: 16px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: opacity 0.2s, transform 0.1s;
      box-shadow: 0 4px 14px rgba(99,102,241,0.35);
    }
    .btn-submit:hover { opacity: 0.92; transform: translateY(-1px); }
    .btn-submit:active { transform: translateY(0); }
    .btn-submit:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

    .security-note {
      font-size: 11px;
      color: var(--gray-500);
      text-align: center;
      line-height: 1.5;
    }

    /* Success screen */
    #screen-success {
      align-items: center;
      justify-content: center;
      padding: 40px;
      text-align: center;
      gap: 16px;
    }
    .success-icon {
      width: 80px; height: 80px;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 36px;
      box-shadow: 0 8px 24px rgba(34,197,94,0.3);
    }
    .success-title { font-size: 24px; font-weight: 800; color: var(--gray-900); }
    .success-msg { font-size: 14px; color: var(--gray-500); line-height: 1.6; max-width: 280px; }
    .success-file {
      background: var(--gray-50);
      border: 1px solid var(--gray-200);
      border-radius: 10px;
      padding: 12px 20px;
      font-size: 13px;
      color: var(--gray-700);
      font-weight: 600;
      width: 100%;
      text-align: center;
    }

    /* Submitting overlay */
    #screen-submitting {
      align-items: center;
      justify-content: center;
      gap: 16px;
      color: var(--gray-500);
    }
    #screen-submitting .spinner {
      border-color: rgba(99,102,241,0.2);
      border-top-color: var(--indigo);
      width: 48px; height: 48px;
    }
    .submitting-text { font-size: 15px; font-weight: 600; color: var(--gray-700); }
    .submitting-sub { font-size: 13px; color: var(--gray-500); }

    /* Responsive */
    @media (max-width: 768px) {
      .layout { grid-template-columns: 1fr; grid-template-rows: 50vh 1fr; }
      .topbar { padding: 12px 16px; }
      .topbar-subtitle { display: none; }
    }
  </style>
</head>
<body>

<!-- Top bar -->
<div class="topbar">
  <div class="topbar-logo">âœï¸</div>
  <div class="topbar-title">LegalLens E-Signature</div>
  <div class="topbar-subtitle" id="topbar-contract">Loading documentâ€¦</div>
</div>

<div class="layout">

  <!-- â”€â”€ Left: PDF Viewer â”€â”€ -->
  <div class="pdf-panel" id="pdf-panel">
    <div class="pdf-loading" id="pdf-loading">
      <div class="spinner"></div>
      <span>Loading documentâ€¦</span>
    </div>
    <div id="pdf-pages"></div>
    <div class="pdf-toolbar" id="pdf-toolbar" style="display:none">
      <button id="btn-prev" onclick="changePage(-1)">â—€</button>
      <span id="page-info">Page 1 of 1</span>
      <button id="btn-next" onclick="changePage(1)">â–¶</button>
      <span style="margin-left:8px; opacity:0.6;">Zoom:</span>
      <button onclick="changeZoom(-0.25)">âˆ’</button>
      <button onclick="changeZoom(0.25)">+</button>
    </div>
  </div>

  <!-- â”€â”€ Right: Sign Panel â”€â”€ -->
  <div class="sign-panel">

    <!-- Loading -->
    <div class="screen active" id="screen-loading">
      <div class="spinner"></div>
      <span>Verifying tokenâ€¦</span>
    </div>

    <!-- Error -->
    <div class="screen" id="screen-error">
      <div class="error-icon">âš ï¸</div>
      <div class="error-title">Unable to Load</div>
      <div class="error-msg" id="error-message">The signing link is invalid or has expired.</div>
    </div>

    <!-- Sign -->
    <div class="screen" id="screen-sign">
      <div class="section-title">Document to Sign</div>
      <div class="contract-card">
        <div class="contract-name" id="contract-name">â€”</div>
        <div class="meta-row">ğŸ‘¤ <span id="signer-name">â€”</span></div>
        <div class="meta-row">ğŸ“… Expires: <span id="expires-date">â€”</span></div>
      </div>

      <div class="email-field">
        <label for="email-input">Confirm your email to proceed</label>
        <input type="email" id="email-input" placeholder="your@email.com" autocomplete="email" />
        <div id="email-error" style="color:var(--red);font-size:12px;display:none">
          âŒ Email does not match the invitation
        </div>
      </div>

      <div class="sig-area">
        <div class="sig-header">
          <div class="section-title" style="margin:0">Your Signature</div>
          <button class="btn-clear" onclick="clearSignature()">Clear</button>
        </div>
        <div class="sig-canvas-wrapper">
          <canvas id="sig-canvas" width="344" height="140"></canvas>
          <div class="sig-placeholder" id="sig-placeholder">
            <span class="sig-placeholder-icon">âœï¸</span>
            <span>Draw your signature here</span>
          </div>
        </div>
      </div>

      <div class="consent-box">
        <input type="checkbox" id="consent-check" />
        <label for="consent-check">
          I agree that this electronic signature is legally binding and I have read and understood the document.
        </label>
      </div>

      <button class="btn-submit" id="btn-submit" onclick="submitSignature()">
        âœ… Sign Document
      </button>

      <div class="security-note">
        ğŸ”’ Secured by LegalLens Â· Your signature is encrypted and timestamped
      </div>
    </div>

    <!-- Submitting -->
    <div class="screen" id="screen-submitting">
      <div class="spinner"></div>
      <div class="submitting-text">Submitting signatureâ€¦</div>
      <div class="submitting-sub">Please wait, this may take a few seconds</div>
    </div>

    <!-- Success -->
    <div class="screen" id="screen-success">
      <div class="success-icon">âœ…</div>
      <div class="success-title">Document Signed!</div>
      <div class="success-msg">
        Your signature has been applied and the signed document has been saved securely.
      </div>
      <div class="success-file" id="success-filename">â€”</div>
      <div class="success-msg" style="font-size:12px">
        You may now close this window.
      </div>
    </div>

  </div>
</div>

<script>
// â”€â”€ Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const API_BASE = 'https://func-legallens-signatures-e3hahsbua2crgrgm.canadacentral-01.azurewebsites.net/api';

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let tokenData = null;
let pdfBytes = null;
let pdfDoc = null;
let currentPage = 1;
let totalPages = 1;
let currentScale = 1.4;
let isDrawing = false;
let hasSignature = false;
let lastX = 0, lastY = 0;

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const params = new URLSearchParams(window.location.search);
const tokenId = params.get('token');

pdfjsLib.GlobalWorkerOptions.workerSrc =
  'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

window.addEventListener('DOMContentLoaded', () => {
  if (!tokenId) return showError('No signing token found in URL.');
  initSignatureCanvas();
  loadToken();
});

// â”€â”€ Screen management â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById('screen-' + id).classList.add('active');
}

function showError(msg) {
  document.getElementById('error-message').textContent = msg;
  showScreen('error');
}

// â”€â”€ Load token â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadToken() {
  try {
    const res = await fetch(`${API_BASE}/validate/${tokenId}`);
    if (!res.ok) {
      const err = await res.json().catch(() => ({}));
      throw new Error(err.error || `HTTP ${res.status}`);
    }

    const data = await res.json();
    tokenData = data;

    // Populate UI
    document.getElementById('contract-name').textContent = data.token.contractName;
    document.getElementById('signer-name').textContent = data.token.signerName;
    document.getElementById('expires-date').textContent =
      new Date(data.token.expires).toLocaleDateString('en-US', { dateStyle: 'long' });
    document.getElementById('topbar-contract').textContent = data.token.contractName;
    document.getElementById('email-input').value = data.token.signerEmail;

    showScreen('sign');

    // Load PDF preview
    loadPDFPreview();

  } catch (err) {
    showError(err.message || 'Failed to validate signing token.');
  }
}

// â”€â”€ PDF Preview â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadPDFPreview() {
  try {
    const res = await fetch(`${API_BASE}/document/${tokenId}`);
    if (!res.ok) throw new Error('Could not load document preview');

    const arrayBuffer = await res.arrayBuffer();
    pdfBytes = new Uint8Array(arrayBuffer);

    pdfDoc = await pdfjsLib.getDocument({ data: pdfBytes }).promise;
    totalPages = pdfDoc.numPages;

    document.getElementById('pdf-loading').style.display = 'none';
    document.getElementById('pdf-toolbar').style.display = 'flex';

    await renderAllPages();
  } catch (err) {
    document.getElementById('pdf-loading').innerHTML =
      '<span style="color:#f87171">âš ï¸ Preview unavailable</span>';
  }
}

async function renderAllPages() {
  const container = document.getElementById('pdf-pages');
  container.innerHTML = '';

  for (let i = 1; i <= totalPages; i++) {
    const page = await pdfDoc.getPage(i);
    const viewport = page.getViewport({ scale: currentScale });

    const wrapper = document.createElement('div');
    wrapper.className = 'pdf-page-wrapper';

    const canvas = document.createElement('canvas');
    canvas.width = viewport.width;
    canvas.height = viewport.height;

    wrapper.appendChild(canvas);
    container.appendChild(wrapper);

    await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;
  }

  updatePageInfo();
}

function updatePageInfo() {
  document.getElementById('page-info').textContent = `${totalPages} page${totalPages > 1 ? 's' : ''}`;
  document.getElementById('btn-prev').disabled = true;
  document.getElementById('btn-next').disabled = true;
}

function changePage(delta) {
  currentPage = Math.max(1, Math.min(totalPages, currentPage + delta));
  renderAllPages();
}

async function changeZoom(delta) {
  currentScale = Math.max(0.5, Math.min(3, currentScale + delta));
  if (pdfDoc) await renderAllPages();
}

// â”€â”€ Signature Canvas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initSignatureCanvas() {
  const canvas = document.getElementById('sig-canvas');
  const ctx = canvas.getContext('2d');

  // Scale canvas for high-DPI screens
  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.getBoundingClientRect();
  canvas.width = (rect.width || 344) * dpr;
  canvas.height = (rect.height || 140) * dpr;
  ctx.scale(dpr, dpr);
  canvas.style.width = (rect.width || 344) + 'px';
  canvas.style.height = '140px';

  ctx.strokeStyle = '#1e293b';
  ctx.lineWidth = 2.5;
  ctx.lineCap = 'round';
  ctx.lineJoin = 'round';

  function getPos(e) {
    const r = canvas.getBoundingClientRect();
    const src = e.touches ? e.touches[0] : e;
    return {
      x: (src.clientX - r.left),
      y: (src.clientY - r.top),
    };
  }

  function startDraw(e) {
    e.preventDefault();
    isDrawing = true;
    const pos = getPos(e);
    lastX = pos.x; lastY = pos.y;
    ctx.beginPath();
    ctx.moveTo(lastX, lastY);
  }

  function draw(e) {
    if (!isDrawing) return;
    e.preventDefault();
    const pos = getPos(e);
    ctx.lineTo(pos.x, pos.y);
    ctx.stroke();
    lastX = pos.x; lastY = pos.y;
    hasSignature = true;
    document.getElementById('sig-placeholder').style.opacity = '0';
  }

  function endDraw() { isDrawing = false; }

  canvas.addEventListener('mousedown', startDraw);
  canvas.addEventListener('mousemove', draw);
  canvas.addEventListener('mouseup', endDraw);
  canvas.addEventListener('mouseleave', endDraw);
  canvas.addEventListener('touchstart', startDraw, { passive: false });
  canvas.addEventListener('touchmove', draw, { passive: false });
  canvas.addEventListener('touchend', endDraw);
}

function clearSignature() {
  const canvas = document.getElementById('sig-canvas');
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  hasSignature = false;
  document.getElementById('sig-placeholder').style.opacity = '1';
}

// â”€â”€ Submit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function submitSignature() {
  const email = document.getElementById('email-input').value.trim();
  const consent = document.getElementById('consent-check').checked;
  const emailErr = document.getElementById('email-error');
  const emailInput = document.getElementById('email-input');

  // Validate email
  if (email.toLowerCase() !== tokenData.token.signerEmail.toLowerCase()) {
    emailInput.classList.add('error');
    emailErr.style.display = 'block';
    emailInput.focus();
    return;
  }
  emailInput.classList.remove('error');
  emailErr.style.display = 'none';

  if (!hasSignature) {
    alert('Please draw your signature before submitting.');
    return;
  }

  if (!consent) {
    alert('Please check the consent box to confirm you agree.');
    return;
  }

  // Get signature as base64 PNG
  const canvas = document.getElementById('sig-canvas');
  const signatureData = canvas.toDataURL('image/png');

  showScreen('submitting');

  try {
    const res = await fetch(`${API_BASE}/sign`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        tokenId,
        email,
        signature: signatureData,
      }),
    });

    const result = await res.json();

    if (!res.ok) throw new Error(result.error || `HTTP ${res.status}`);

    // Success
    document.getElementById('success-filename').textContent =
      'ğŸ“„ ' + (result.signedDocument || 'Document signed successfully');
    showScreen('success');

  } catch (err) {
    showError('Submission failed: ' + (err.message || 'Unknown error'));
  }
}
</script>
</body>
</html>
