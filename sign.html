<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>LegalLens â€” Sign Document</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --indigo:#6366f1;--purple:#8b5cf6;--green:#22c55e;--red:#ef4444;
  --gray-50:#f8fafc;--gray-100:#f1f5f9;--gray-200:#e2e8f0;
  --gray-500:#64748b;--gray-700:#334155;--gray-900:#0f172a;
}
body{font-family:'Segoe UI',system-ui,sans-serif;background:var(--gray-100);color:var(--gray-900);min-height:100vh}
/* topbar */
.topbar{background:#fff;border-bottom:1px solid var(--gray-200);padding:14px 32px;display:flex;align-items:center;gap:12px;position:sticky;top:0;z-index:100;box-shadow:0 1px 4px rgba(0,0,0,.06)}
.topbar-logo{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,var(--indigo),var(--purple));display:flex;align-items:center;justify-content:center;font-size:18px}
.topbar-title{font-weight:700;font-size:18px}
.topbar-sub{font-size:13px;color:var(--gray-500);margin-left:auto}
/* layout */
.layout{display:grid;grid-template-columns:1fr 420px;height:calc(100vh - 65px)}
/* pdf panel */
.pdf-panel{background:#525659;overflow-y:auto;display:flex;flex-direction:column;align-items:center;padding:24px 16px;gap:16px}
.pdf-loading{color:#fff;font-size:15px;margin-top:60px;display:flex;flex-direction:column;align-items:center;gap:16px}
.spinner{width:40px;height:40px;border:3px solid rgba(255,255,255,.2);border-top-color:#fff;border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.pdf-page-wrapper{background:#fff;box-shadow:0 4px 20px rgba(0,0,0,.4);border-radius:4px;overflow:hidden;margin-bottom:4px}
.pdf-page-wrapper canvas{display:block}
.pdf-toolbar{background:rgba(0,0,0,.5);color:#fff;padding:8px 16px;border-radius:20px;font-size:13px;position:sticky;bottom:16px;display:flex;align-items:center;gap:10px}
.pdf-toolbar button{background:rgba(255,255,255,.15);border:none;color:#fff;padding:4px 12px;border-radius:12px;cursor:pointer;font-size:13px}
.pdf-toolbar button:hover{background:rgba(255,255,255,.25)}
/* sign panel */
.sign-panel{background:#fff;border-left:1px solid var(--gray-200);overflow-y:auto;display:flex;flex-direction:column}
.screen{display:none;flex-direction:column;height:100%}
.screen.active{display:flex}
/* loading/error */
#screen-loading,#screen-submitting{align-items:center;justify-content:center;gap:16px;color:var(--gray-500);font-size:15px}
#screen-loading .spinner,#screen-submitting .spinner{border-color:rgba(99,102,241,.2);border-top-color:var(--indigo)}
#screen-submitting .spinner{width:48px;height:48px}
#screen-error{align-items:center;justify-content:center;padding:40px;text-align:center;gap:12px}
.err-icon{font-size:48px}.err-title{font-size:20px;font-weight:700;color:var(--red)}.err-msg{color:var(--gray-500);font-size:14px;line-height:1.6}
/* email screen */
#screen-email{padding:40px 32px;gap:20px;justify-content:center}
.email-hero{text-align:center;margin-bottom:8px}
.email-hero-icon{font-size:48px;margin-bottom:12px}
.email-hero h2{font-size:22px;font-weight:800;color:var(--gray-900);margin-bottom:6px}
.email-hero p{font-size:14px;color:var(--gray-500);line-height:1.6}
.field-label{font-size:13px;font-weight:600;color:var(--gray-700);margin-bottom:6px;display:block}
.field-input{width:100%;border:1.5px solid var(--gray-200);border-radius:10px;padding:12px 16px;font-size:15px;color:var(--gray-900);outline:none;transition:border-color .2s}
.field-input:focus{border-color:var(--indigo)}
.field-input.error{border-color:var(--red)}
.field-error{color:var(--red);font-size:12px;margin-top:4px;display:none}
/* sign screen */
#screen-sign{padding:24px;gap:18px;overflow-y:auto}
.sec-title{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--gray-500)}
.contract-card{background:var(--gray-50);border:1px solid var(--gray-200);border-radius:12px;padding:16px}
.contract-name{font-size:16px;font-weight:700;color:var(--gray-900);margin-bottom:8px}
.meta{font-size:12px;color:var(--gray-500);display:flex;align-items:center;gap:6px;margin-bottom:4px}
/* signature tabs */
.sig-tabs{display:flex;gap:6px;border-bottom:1px solid var(--gray-200);padding-bottom:0}
.sig-tab{padding:8px 16px;font-size:12px;font-weight:600;color:var(--gray-500);border:none;background:none;cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-1px}
.sig-tab.active{color:var(--indigo);border-bottom-color:var(--indigo)}
.sig-tab-panel{display:none;padding:16px 0}
.sig-tab-panel.active{display:block}
/* draw canvas */
.canvas-wrapper{border:2px dashed var(--gray-200);border-radius:12px;background:var(--gray-50);overflow:hidden;position:relative;transition:border-color .2s}
.canvas-wrapper:hover{border-color:var(--indigo)}
.canvas-wrapper canvas{display:block;cursor:crosshair;touch-action:none}
.sig-placeholder{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;color:var(--gray-500);font-size:13px;pointer-events:none;gap:6px}
.sig-placeholder-icon{font-size:28px;opacity:.4}
/* themes */
.theme-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px}
.theme-btn{border:2px solid transparent;border-radius:10px;padding:10px 8px;cursor:pointer;font-size:12px;font-weight:600;text-align:center;background:var(--gray-50);transition:all .15s}
.theme-btn:hover{border-color:var(--indigo)}
.theme-btn.selected{border-color:var(--indigo);background:rgba(99,102,241,.08)}
.theme-preview{height:36px;border-radius:6px;display:flex;align-items:center;justify-content:center;margin-bottom:6px;font-size:13px}
/* upload */
.upload-zone{border:2px dashed var(--gray-200);border-radius:12px;padding:24px;text-align:center;cursor:pointer;transition:all .2s;background:var(--gray-50)}
.upload-zone:hover,.upload-zone.drag{border-color:var(--indigo);background:rgba(99,102,241,.04)}
.upload-preview{max-width:100%;max-height:80px;margin-top:12px;border-radius:8px;border:1px solid var(--gray-200)}
/* consent */
.consent{background:#f0fdf4;border:1px solid #bbf7d0;border-radius:10px;padding:14px;display:flex;gap:10px;align-items:flex-start}
.consent input[type=checkbox]{margin-top:2px;accent-color:var(--green)}
.consent label{font-size:13px;color:#166534;line-height:1.5}
/* buttons */
.btn-row{display:flex;gap:8px}
.btn-clear{background:none;border:1px solid var(--gray-200);color:var(--gray-500);padding:5px 12px;border-radius:8px;font-size:12px;cursor:pointer}
.btn-clear:hover{background:var(--gray-100)}
.btn-submit{background:linear-gradient(135deg,var(--indigo),var(--purple));color:#fff;border:none;border-radius:12px;padding:16px;font-size:16px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;transition:opacity .2s,transform .1s;box-shadow:0 4px 14px rgba(99,102,241,.35)}
.btn-submit:hover{opacity:.92;transform:translateY(-1px)}
.btn-submit:disabled{opacity:.5;cursor:not-allowed;transform:none}
.btn-next{background:linear-gradient(135deg,var(--indigo),var(--purple));color:#fff;border:none;border-radius:10px;padding:13px 28px;font-size:14px;font-weight:700;cursor:pointer;box-shadow:0 4px 14px rgba(99,102,241,.35);transition:opacity .15s}
.btn-next:hover{opacity:.9}
.security-note{font-size:11px;color:var(--gray-500);text-align:center;line-height:1.5}
/* success */
#screen-success{align-items:center;justify-content:center;padding:40px;text-align:center;gap:16px}
.success-icon{width:80px;height:80px;background:linear-gradient(135deg,#22c55e,#16a34a);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:36px;box-shadow:0 8px 24px rgba(34,197,94,.3)}
.success-title{font-size:24px;font-weight:800}
.success-msg{font-size:14px;color:var(--gray-500);line-height:1.6;max-width:280px}
.success-file{background:var(--gray-50);border:1px solid var(--gray-200);border-radius:10px;padding:12px 20px;font-size:13px;color:var(--gray-700);font-weight:600;width:100%;text-align:center}
@media(max-width:768px){.layout{grid-template-columns:1fr;grid-template-rows:45vh 1fr}.topbar{padding:12px 16px}.topbar-sub{display:none}}
</style>
</head>
<body>
<div class="topbar">
  <div class="topbar-logo">âœï¸</div>
  <div class="topbar-title">LegalLens E-Signature</div>
  <div class="topbar-sub" id="topbar-contract">Loadingâ€¦</div>
</div>
<div class="layout">
  <!-- PDF Panel -->
  <div class="pdf-panel" id="pdf-panel">
    <div class="pdf-loading" id="pdf-loading"><div class="spinner"></div><span>Loading documentâ€¦</span></div>
    <div id="pdf-pages"></div>
    <div class="pdf-toolbar" id="pdf-toolbar" style="display:none">
      <span id="page-count">Loadingâ€¦</span>
      <button onclick="changeZoom(-.25)">âˆ’</button>
      <button onclick="changeZoom(.25)">+</button>
    </div>
  </div>

  <!-- Sign Panel -->
  <div class="sign-panel">

    <!-- Loading -->
    <div class="screen active" id="screen-loading">
      <div class="spinner"></div><span>Verifying tokenâ€¦</span>
    </div>

    <!-- Error -->
    <div class="screen" id="screen-error">
      <div class="err-icon">âš ï¸</div>
      <div class="err-title">Unable to Load</div>
      <div class="err-msg" id="error-message">The signing link is invalid or has expired.</div>
    </div>

    <!-- Step 1: Email Verification -->
    <div class="screen" id="screen-email">
      <div class="email-hero">
        <div class="email-hero-icon">ğŸ”</div>
        <h2>Verify Your Identity</h2>
        <p>Enter the email address where you received this invitation to proceed.</p>
      </div>
      <div>
        <label class="field-label" for="email-input">Your Email Address</label>
        <input class="field-input" type="email" id="email-input" placeholder="your@email.com" autocomplete="email"/>
        <div class="field-error" id="email-error">âŒ Email does not match the invitation</div>
      </div>
      <div class="contract-card" style="margin-top:4px">
        <div class="contract-name" id="contract-name-email">â€”</div>
        <div class="meta">ğŸ‘¤ <span id="signer-name">â€”</span></div>
        <div class="meta">ğŸ“… Expires: <span id="expires-date">â€”</span></div>
      </div>
      <button class="btn-next" onclick="verifyEmail()">Continue to Sign â†’</button>
      <div class="security-note">ğŸ”’ Your identity is verified before signing</div>
    </div>

    <!-- Step 2: Sign -->
    <div class="screen" id="screen-sign">
      <div class="sec-title" style="padding:20px 24px 0">Document</div>
      <div style="padding:0 24px 0">
        <div class="contract-card">
          <div class="contract-name" id="contract-name-sign">â€”</div>
          <div class="meta">âœ… Identity verified</div>
        </div>
      </div>

      <!-- Signature Section -->
      <div style="padding:0 24px">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;margin-top:16px">
          <div class="sec-title">Your Signature</div>
          <button class="btn-clear" onclick="clearSig()">Clear</button>
        </div>

        <!-- Tabs: Draw / Themes / Upload -->
        <div class="sig-tabs">
          <button class="sig-tab active" onclick="switchTab('draw',this)">âœï¸ Draw</button>
          <button class="sig-tab" onclick="switchTab('themes',this)">ğŸ¨ Themes</button>
          <button class="sig-tab" onclick="switchTab('upload',this)">â¬†ï¸ Upload</button>
        </div>

        <!-- Draw Tab -->
        <div class="sig-tab-panel active" id="tab-draw">
          <div class="canvas-wrapper">
            <canvas id="sig-canvas" width="370" height="130"></canvas>
            <div class="sig-placeholder" id="sig-placeholder">
              <span class="sig-placeholder-icon">âœï¸</span>
              <span>Draw your signature here</span>
            </div>
          </div>
          <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
            <div class="sec-title" style="margin:0">Color:</div>
            <div style="display:flex;gap:6px">
              <button onclick="setSigColor('#1e293b',this)" style="width:22px;height:22px;border-radius:50%;background:#1e293b;border:2px solid #6366f1;cursor:pointer" title="Black"></button>
              <button onclick="setSigColor('#1d4ed8',this)" style="width:22px;height:22px;border-radius:50%;background:#1d4ed8;border:2px solid transparent;cursor:pointer" title="Blue"></button>
              <button onclick="setSigColor('#15803d',this)" style="width:22px;height:22px;border-radius:50%;background:#15803d;border:2px solid transparent;cursor:pointer" title="Green"></button>
              <button onclick="setSigColor('#7c3aed',this)" style="width:22px;height:22px;border-radius:50%;background:#7c3aed;border:2px solid transparent;cursor:pointer" title="Purple"></button>
            </div>
          </div>
        </div>

        <!-- Themes Tab -->
        <div class="sig-tab-panel" id="tab-themes">
          <div class="sec-title" style="margin-bottom:10px">Select a signature style</div>
          <div class="theme-grid" id="theme-grid"></div>
          <div id="theme-preview-area" style="display:none;margin-top:8px">
            <canvas id="theme-canvas" width="370" height="80" style="border-radius:10px;border:1.5px solid var(--gray-200);width:100%"></canvas>
          </div>
        </div>

        <!-- Upload Tab -->
        <div class="sig-tab-panel" id="tab-upload">
          <div class="upload-zone" id="upload-zone" onclick="document.getElementById('sig-file').click()"
               ondragover="event.preventDefault();this.classList.add('drag')"
               ondragleave="this.classList.remove('drag')"
               ondrop="handleDrop(event)">
            <div style="font-size:28px;margin-bottom:8px">ğŸ“</div>
            <div style="font-size:14px;font-weight:600;color:var(--gray-700)">Click or drag & drop</div>
            <div style="font-size:12px;color:var(--gray-500);margin-top:4px">PNG or JPG signature image</div>
            <img id="upload-preview" class="upload-preview" style="display:none"/>
          </div>
          <input type="file" id="sig-file" accept="image/png,image/jpeg" style="display:none" onchange="handleUpload(event)"/>
        </div>
      </div>

      <!-- Consent -->
      <div style="padding:0 24px">
        <div class="consent">
          <input type="checkbox" id="consent-check"/>
          <label for="consent-check">I agree that this electronic signature is legally binding and I have read and understood the document.</label>
        </div>
      </div>

      <!-- Submit -->
      <div style="padding:0 24px 24px">
        <button class="btn-submit" onclick="submitSig()">âœ… Sign Document</button>
        <div class="security-note" style="margin-top:10px">ğŸ”’ Secured by LegalLens Â· Encrypted & timestamped</div>
      </div>
    </div>

    <!-- Submitting -->
    <div class="screen" id="screen-submitting">
      <div class="spinner"></div>
      <div style="font-size:15px;font-weight:600;color:var(--gray-700)">Submitting signatureâ€¦</div>
      <div style="font-size:13px;color:var(--gray-500)">Please wait a few seconds</div>
    </div>

    <!-- Success -->
    <div class="screen" id="screen-success">
      <div class="success-icon">âœ…</div>
      <div class="success-title">Document Signed!</div>
      <div class="success-msg">Your signature has been applied and the signed PDF saved securely.</div>
      <div class="success-file" id="success-filename">â€”</div>
      <div class="success-msg" style="font-size:12px">You may now close this window.</div>
    </div>

  </div>
</div>

<script>
const API_BASE = 'https://func-legallens-signatures-e3hahsbua2crgrgm.canadacentral-01.azurewebsites.net/api';
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

let tokenData = null;
let pdfDoc = null;
let scale = 1.4;
let hasDrawing = false;
let activeTab = 'draw';
let sigColor = '#1e293b';
let uploadedSig = null;
let selectedThemeSig = null;
let selectedTheme = null;

// â”€â”€ themes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const THEMES = [
  { id:'classic', label:'Classic',  font:'30px Georgia, serif',          color:'#1e293b', style:'italic' },
  { id:'modern',  label:'Modern',   font:'bold 26px Arial, sans-serif',   color:'#1d4ed8', style:'normal' },
  { id:'elegant', label:'Elegant',  font:'28px "Palatino Linotype", serif',color:'#15803d', style:'italic' },
  { id:'bold',    label:'Bold',     font:'bold 28px Impact, sans-serif',  color:'#1e293b', style:'normal' },
  { id:'script',  label:'Script',   font:'28px "Brush Script MT", cursive',color:'#7c3aed', style:'italic' },
  { id:'minimal', label:'Minimal',  font:'22px "Courier New", monospace', color:'#374151', style:'normal' },
];

// â”€â”€ screens â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById('screen-' + id).classList.add('active');
}
function showError(msg) { document.getElementById('error-message').textContent = msg; showScreen('error'); }

// â”€â”€ init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const params = new URLSearchParams(location.search);
const tokenId = params.get('token');

window.addEventListener('DOMContentLoaded', () => {
  if (!tokenId) return showError('No signing token found in URL.');
  buildThemeGrid();
  initCanvas();
  loadToken();
});

async function loadToken() {
  try {
    const res = await fetch(`${API_BASE}/validate/${tokenId}`);
    if (!res.ok) { const e = await res.json().catch(()=>({})); throw new Error(e.error||`HTTP ${res.status}`); }
    tokenData = await res.json();
    const t = tokenData.token;
    document.getElementById('contract-name-email').textContent = t.contractName;
    document.getElementById('contract-name-sign').textContent  = t.contractName;
    document.getElementById('signer-name').textContent  = t.signerName;
    document.getElementById('expires-date').textContent = new Date(t.expires).toLocaleDateString('en-US',{dateStyle:'long'});
    document.getElementById('topbar-contract').textContent = t.contractName;
    document.getElementById('email-input').value = t.signerEmail;
    showScreen('email');
    loadPDF();
  } catch(err) { showError(err.message||'Failed to validate token.'); }
}

// â”€â”€ Email verification â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function verifyEmail() {
  const val = document.getElementById('email-input').value.trim();
  const errEl = document.getElementById('email-error');
  const inEl  = document.getElementById('email-input');
  if (val.toLowerCase() !== tokenData.token.signerEmail.toLowerCase()) {
    inEl.classList.add('error'); errEl.style.display = 'block'; inEl.focus(); return;
  }
  inEl.classList.remove('error'); errEl.style.display = 'none';
  showScreen('sign');
}

// â”€â”€ PDF Preview â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadPDF() {
  try {
    const res = await fetch(`${API_BASE}/document/${tokenId}`);
    if (!res.ok) throw new Error('Preview unavailable');
    const buf = await res.arrayBuffer();
    pdfDoc = await pdfjsLib.getDocument({data: new Uint8Array(buf)}).promise;
    document.getElementById('pdf-loading').style.display = 'none';
    document.getElementById('pdf-toolbar').style.display = 'flex';
    document.getElementById('page-count').textContent = `${pdfDoc.numPages} page${pdfDoc.numPages>1?'s':''}`;
    renderAllPages();
  } catch { document.getElementById('pdf-loading').innerHTML='<span style="color:#f87171">âš ï¸ Preview unavailable</span>'; }
}
async function renderAllPages() {
  const c = document.getElementById('pdf-pages'); c.innerHTML = '';
  for (let i=1; i<=pdfDoc.numPages; i++) {
    const page = await pdfDoc.getPage(i);
    const vp   = page.getViewport({scale});
    const wrap = document.createElement('div'); wrap.className='pdf-page-wrapper';
    const canvas = document.createElement('canvas'); canvas.width=vp.width; canvas.height=vp.height;
    wrap.appendChild(canvas); c.appendChild(wrap);
    await page.render({canvasContext:canvas.getContext('2d'),viewport:vp}).promise;
  }
}
async function changeZoom(d) { scale = Math.max(.5, Math.min(3, scale+d)); if(pdfDoc) await renderAllPages(); }

// â”€â”€ Signature canvas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initCanvas() {
  const canvas = document.getElementById('sig-canvas');
  const ctx = canvas.getContext('2d');
  let drawing = false, lx=0, ly=0;
  ctx.strokeStyle = sigColor; ctx.lineWidth=2.5; ctx.lineCap='round'; ctx.lineJoin='round';

  function pos(e) {
    const r = canvas.getBoundingClientRect();
    const s = e.touches?e.touches[0]:e;
    return {x:(s.clientX-r.left)*(canvas.width/r.width), y:(s.clientY-r.top)*(canvas.height/r.height)};
  }
  function start(e){ e.preventDefault(); drawing=true; const p=pos(e); lx=p.x; ly=p.y; ctx.beginPath(); ctx.moveTo(lx,ly); }
  function move(e){ if(!drawing) return; e.preventDefault(); const p=pos(e); ctx.strokeStyle=sigColor; ctx.lineTo(p.x,p.y); ctx.stroke(); lx=p.x; ly=p.y; hasDrawing=true; document.getElementById('sig-placeholder').style.opacity='0'; }
  function stop(){ drawing=false; }
  canvas.addEventListener('mousedown',start); canvas.addEventListener('mousemove',move); canvas.addEventListener('mouseup',stop); canvas.addEventListener('mouseleave',stop);
  canvas.addEventListener('touchstart',start,{passive:false}); canvas.addEventListener('touchmove',move,{passive:false}); canvas.addEventListener('touchend',stop);
}

function setSigColor(c,btn) {
  sigColor=c;
  document.querySelectorAll('[onclick^="setSigColor"]').forEach(b=>b.style.border='2px solid transparent');
  btn.style.border='2px solid #6366f1';
  // re-draw if using theme
  if(selectedTheme) drawThemeSig(selectedTheme);
}
function clearSig() {
  const canvas=document.getElementById('sig-canvas');
  canvas.getContext('2d').clearRect(0,0,canvas.width,canvas.height);
  hasDrawing=false; uploadedSig=null; selectedThemeSig=null; selectedTheme=null;
  document.getElementById('sig-placeholder').style.opacity='1';
  document.getElementById('upload-preview').style.display='none';
  document.querySelectorAll('.theme-btn').forEach(b=>b.classList.remove('selected'));
  document.getElementById('theme-preview-area').style.display='none';
}

// â”€â”€ Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(name, btn) {
  activeTab = name;
  document.querySelectorAll('.sig-tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.sig-tab-panel').forEach(p=>p.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('tab-'+name).classList.add('active');
}

// â”€â”€ Themes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildThemeGrid() {
  const grid = document.getElementById('theme-grid');
  THEMES.forEach(t => {
    const btn = document.createElement('button');
    btn.className='theme-btn'; btn.dataset.id=t.id;
    btn.innerHTML=`<div class="theme-preview" style="font:${t.font};color:${t.color};font-style:${t.style}">Sign</div><div>${t.label}</div>`;
    btn.onclick=()=>{ document.querySelectorAll('.theme-btn').forEach(b=>b.classList.remove('selected')); btn.classList.add('selected'); selectedTheme=t; drawThemeSig(t); };
    grid.appendChild(btn);
  });
}
function drawThemeSig(t) {
  const name = tokenData?.token?.signerName || 'Signature';
  const area = document.getElementById('theme-preview-area'); area.style.display='block';
  const canvas = document.getElementById('theme-canvas');
  const ctx = canvas.getContext('2d');
  canvas.width=370; canvas.height=80;
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle='#f8fafc'; ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.font=t.font; ctx.fillStyle=sigColor||t.color; ctx.fontStyle=t.style;
  ctx.textBaseline='middle'; ctx.fillText(name, 16, 40);
  selectedThemeSig = canvas.toDataURL('image/png');
}

// â”€â”€ Upload â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleDrop(e) {
  e.preventDefault(); document.getElementById('upload-zone').classList.remove('drag');
  const file = e.dataTransfer.files[0]; if(file) readImageFile(file);
}
function handleUpload(e) { const file=e.target.files[0]; if(file) readImageFile(file); }
function readImageFile(file) {
  const r=new FileReader();
  r.onload=ev=>{ uploadedSig=ev.target.result; const img=document.getElementById('upload-preview'); img.src=uploadedSig; img.style.display='block'; };
  r.readAsDataURL(file);
}

// â”€â”€ Get final signature data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getFinalSignature() {
  if (activeTab==='upload') return uploadedSig;
  if (activeTab==='themes') return selectedThemeSig;
  // draw
  if (!hasDrawing) return null;
  return document.getElementById('sig-canvas').toDataURL('image/png');
}

// â”€â”€ Submit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function submitSig() {
  const sig = getFinalSignature();
  if (!sig) { alert('Please provide your signature before submitting.'); return; }
  if (!document.getElementById('consent-check').checked) { alert('Please check the consent box to confirm you agree.'); return; }

  const email = document.getElementById('email-input').value.trim();
  showScreen('submitting');

  try {
    const res = await fetch(`${API_BASE}/sign`, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ tokenId, email, signature: sig }),
    });
    const result = await res.json();
    if (!res.ok) throw new Error(result.error || `HTTP ${res.status}`);
    document.getElementById('success-filename').textContent = 'ğŸ“„ ' + (result.signedDocument || 'Document signed');
    showScreen('success');
  } catch(err) { showError('Submission failed: ' + (err.message||'Unknown error')); }
}
</script>
</body>
</html>
